# `index.html` Bridge 스크립트 고도화 매뉴얼 (2026-02-10)

## 목적

고객 사이트 `index.html` 1회 삽입만으로 안정적인 이벤트 수집과 리포트 반영을 보장하기 위한 고도화 기준입니다.

## 기본 구조

1. 고객 페이지에서 `bridge.js` 비동기 로드
2. 클라이언트 이벤트 큐 생성
3. 배치 전송(`sendBeacon` 우선)
4. 서버에서 수신/검증/정규화
5. Proof/리포트/대시보드 지표 반영

## 클라이언트 요구사항

- 이벤트 고유 ID(`event_id`) 필수
- 전송 시각(`sent_at`) 필수
- 세션 식별자(`session_id`) 필수
- 실패 시 재시도 정책(백오프) 적용
- SPA 라우트 변경 감지 지원

## 서버 요구사항

- 엔드포인트: `POST /api/bridge/{script_id}/events`
- 스키마 검증 + 서명/만료/Origin 검증
- 중복 이벤트 제거
- 드롭 사유 분류 저장

## 데이터 모델 권장

- Raw 이벤트 저장소(원본 보존)
- 정규화 이벤트 저장소(분석/리포트용)
- 처리 상태 플래그와 재처리 포인트 분리

## 신뢰성 기준

- 수락률/드롭률을 조직/사이트 단위로 관측
- 재시도 후 성공률 추적
- 지표 계산 테이블과 원본 테이블 정합성 확인

## 보안 기준

- `BRIDGE_SIGNING_SECRET` 환경별 분리
- PII 최소 수집 원칙
- 저장 전 민감 필드 마스킹

## 단계별 실행

### 1단계: 안정화
- 스키마 고정
- 배치 수신 API 도입
- 기본 모니터링 지표 구축

### 2단계: 신뢰성
- 멱등성 강화
- 재시도/드롭 정책 정교화
- 부하 상황 성능 검증

### 3단계: 완전 연동
- Proof/Attribution/Report 데이터 체인 연결
- 설치 품질 지표 UI 노출
- 운영 장애 대응 플레이북 확정
