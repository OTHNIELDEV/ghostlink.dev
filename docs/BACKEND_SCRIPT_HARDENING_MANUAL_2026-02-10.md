# 백엔드 스크립트 하드닝 매뉴얼 (2026-02-10)

## 목적

Bridge/수집/정규화 스크립트 계층을 운영 환경에서 안전하게 실행하기 위한 하드닝 기준을 정의합니다.

## 적용 범위

- `app/routers/bridge.py`
- `app/models/analytics.py`
- `app/services/report_service.py`
- 관련 배치/재처리 흐름

## 핵심 원칙

1. 입력 검증 우선
- `script_id`, 토큰, 타임스탬프, 페이로드 스키마를 먼저 검증

2. 멱등성 보장
- 이벤트 고유 ID(`event_id`) 기반 중복 제거
- 재전송/중복 수신을 정상 시나리오로 처리

3. 실패 격리
- 일부 이벤트 실패가 전체 요청 실패로 전파되지 않도록 설계
- 재시도 가능한 실패와 폐기 대상 실패를 분리

4. 추적 가능성
- 수집 단계별 상태(`accepted`, `dropped`, `normalized`)를 기록
- 오류 사유(`reason`)를 집계 가능한 형태로 저장

## 입력 보안 체크리스트

- 허용된 Origin/Referer 검증
- 토큰 만료 시간 검증
- payload 크기 상한
- 이벤트 배열 개수 상한
- 민감정보(PII) 포함 여부 필터링

## 저장소 설계 가이드

- Raw 이벤트 테이블과 정규화 테이블 분리
- Raw 테이블은 진단/재처리에 필요한 최소 필드 보존
- 정규화 테이블은 리포트/지표 계산 중심으로 최적화

## 재시도 정책

- 네트워크/일시 오류: 지수 백오프 재시도
- 스키마 불일치/무효 토큰: 즉시 폐기
- 반복 실패는 별도 대기열로 격리 후 운영 확인

## 관측 지표

- 이벤트 수락률
- 드롭률 및 상위 드롭 사유
- 정규화 성공률
- 재시도 횟수 분포
- 지연 시간(P50/P95)

## 배포 전 점검

- 스테이징에서 부하 시나리오(배치/동시성) 검증
- 중복 이벤트 주입 시 멱등성 확인
- 리포트 지표와 원본 이벤트 수치 정합성 확인

## 장애 대응 절차

1. 드롭률 급증 시 최근 배포 변경점 확인
2. 토큰/시크릿 만료 여부 확인
3. 특정 `script_id` 편중 발생 여부 확인
4. 필요 시 Raw 이벤트 재처리 작업 실행
