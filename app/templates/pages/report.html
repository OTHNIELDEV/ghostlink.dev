{% extends "layouts/base.html" %}

{% block content %}
<div class="relative min-h-screen bg-slate-900 overflow-hidden" x-data="{ activeTab: 'overview' }">
    <!-- Background Elements -->
    <div
        class="absolute -top-[20%] -left-[10%] w-[70%] h-[70%] rounded-full bg-blue-500/10 blur-[120px] pointer-events-none">
    </div>
    <div
        class="absolute top-[40%] -right-[10%] w-[60%] h-[60%] rounded-full bg-emerald-500/10 blur-[100px] pointer-events-none">
    </div>

    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
            <div>
                <a href="/dashboard"
                    class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-colors mb-4 group">
                    <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
                    AIO Audit Report
                </h1>
                <p class="text-lg text-slate-400 flex items-center gap-2">
                    <img src="https://www.google.com/s2/favicons?domain={{ site.url }}&sz=32" alt="Favicon"
                        class="w-5 h-5 rounded-sm opacity-80">
                    <a href="{{ site.url }}" target="_blank"
                        class="hover:text-emerald-400 transition-colors border-b border-transparent hover:border-emerald-400/50 pb-0.5">{{
                        site.url }}</a>
                </p>
            </div>
            {% set lang_options = language_options if language_options is defined else [
                ('auto', 'Auto (Country Default)'),
                ('en', 'English'),
                ('ko', 'Korean (한국어)'),
                ('ja', 'Japanese (日本語)'),
                ('zh-cn', 'Chinese Simplified (简体中文)'),
                ('zh-tw', 'Chinese Traditional (繁體中文)'),
                ('es', 'Spanish (Español)'),
                ('fr', 'French (Français)'),
                ('de', 'German (Deutsch)'),
                ('pt-br', 'Portuguese BR (Português)'),
                ('it', 'Italian (Italiano)'),
                ('ru', 'Russian (Русский)'),
                ('ar', 'Arabic (العربية)'),
                ('hi', 'Hindi (हिन्दी)'),
                ('vi', 'Vietnamese (Tiếng Việt)'),
                ('th', 'Thai (ไทย)'),
                ('id', 'Indonesian (Bahasa Indonesia)'),
                ('tr', 'Turkish (Türkçe)'),
                ('nl', 'Dutch (Nederlands)'),
                ('pl', 'Polish (Polski)')
            ] %}
            <div class="flex flex-col items-start md:items-end gap-3">
                <div class="flex flex-wrap items-center gap-2">
                    <select
                        id="report-language"
                        class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200">
                        {% for code, label in lang_options %}
                        <option value="{{ code }}" {% if (site.preferred_language or 'auto') == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button
                        class="px-3 py-2 rounded-lg text-xs font-semibold border border-slate-600 bg-slate-800 text-slate-200 hover:bg-slate-700 transition-colors"
                        onclick="updateReportLanguage({{ site.id }}, {{ org_id }})">
                        Apply to All Sites
                    </button>
                    <button
                        class="px-3 py-2 rounded-lg text-xs font-semibold border border-emerald-500/40 bg-emerald-500/20 text-emerald-200 hover:bg-emerald-500/30 transition-colors"
                        onclick="rescanSiteWithLanguage({{ site.id }}, {{ org_id }})">
                        Rescan Now
                    </button>
                </div>
                <div class="text-xs text-slate-500">
                    Effective: {{ site.effective_language_label if site.effective_language_label is defined else 'English' }}
                </div>
                <div class="flex flex-wrap items-center gap-2 text-[10px] uppercase tracking-wider">
                    <span class="px-2 py-0.5 rounded-full border border-amber-500/35 bg-amber-500/10 text-amber-300">
                        Score predicted
                    </span>
                    {% if proof_overview_30d and proof_overview_30d.total_queries_scored > 0 %}
                    <span class="px-2 py-0.5 rounded-full border border-cyan-500/35 bg-cyan-500/10 text-cyan-300">
                        Proof measured
                    </span>
                    <span class="px-2 py-0.5 rounded-full border border-slate-600 bg-slate-900 text-slate-300">
                        Confidence {{ proof_overview_30d.confidence_level }}
                    </span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-slate-400 text-sm mb-1 uppercase tracking-wider font-semibold">Total Score</p>
                        <div
                            class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">
                            {{ analysis.scores.total if analysis.scores else site.ai_score }}
                        </div>
                    </div>
                    <!-- Grade Circle -->
                    <div class="relative w-24 h-24 flex items-center justify-center">
                        <svg class="absolute inset-0 w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent"
                                class="text-slate-800" />
                            <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent"
                                class="text-emerald-500 transition-all duration-1000 ease-out" stroke-dasharray="251.2"
                                stroke-dashoffset="{{ 251.2 - (251.2 * (analysis.scores.total if analysis.scores else site.ai_score) / 100) }}"
                                stroke-linecap="round" />
                        </svg>
                        <span class="text-2xl font-bold text-white">
                            {% set score = analysis.scores.total if analysis.scores else site.ai_score %}
                            {% if score >= 90 %}A+{% elif score >= 80 %}A{% elif score >= 70 %}B{% elif score >= 60 %}C{%
                            else %}D{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        {% if not analysis.scores %}
        <!-- Empty State / Processing -->
        <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-12 text-center">
            <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                    </path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Detailed Report Not Available</h3>
            <p class="text-slate-400 mb-8 max-w-md mx-auto">
                Enhanced analysis data is missing. This site might have been scanned with an older version of the
                scanner.
            </p>
            <button
                class="px-6 py-3 bg-emerald-500 hover:bg-emerald-400 text-white font-semibold rounded-lg transition-colors shadow-lg shadow-emerald-500/20 disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="rescanSiteWithLanguage({{ site.id }}, {{ org_id }})">
                Re-Scan Now
            </button>
        </div>
        {% else %}

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Radar Chart & Keywords -->
            <div class="space-y-8">
                <!-- Radar Chart Card -->
                <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                        Performance Matrix
                    </h3>
                    <div class="relative w-full aspect-square max-h-[300px] mx-auto">
                        <canvas id="scoreRadarChart"></canvas>
                    </div>
                </div>

                <!-- Keywords Card -->
                <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                        </svg>
                        Top Keywords
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        {% for keyword in analysis.summary_keywords %}
                        <span
                            class="px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded-lg text-slate-300 text-sm">#
                            {{ keyword }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Right Column: Detailed Breakdown -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Pros & Cons -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Pros -->
                    <div
                        class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6 relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-emerald-500/5 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <span
                                class="flex items-center justify-center w-8 h-8 rounded-lg bg-emerald-500/10 text-emerald-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </span>
                            Strengths
                        </h3>
                        <ul class="space-y-3">
                            {% for pro in analysis.pros %}
                            <li class="flex items-start gap-3 text-slate-300 text-sm">
                                <svg class="w-5 h-5 text-emerald-500/70 shrink-0 mt-0.5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {{ pro }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Cons -->
                    <div
                        class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6 relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-red-500/5 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110">
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <span
                                class="flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/10 text-red-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                    </path>
                                </svg>
                            </span>
                            Areas for Improvement
                        </h3>
                        <ul class="space-y-3">
                            {% for con in analysis.cons %}
                            <li class="flex items-start gap-3 text-slate-300 text-sm">
                                <svg class="w-5 h-5 text-red-500/70 shrink-0 mt-0.5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {{ con }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        AI Recommendations
                    </h3>
                    <div class="space-y-4">
                        {% for rec in analysis.recommendations %}
                        <div
                            class="flex items-start gap-4 p-4 rounded-xl bg-slate-900/50 border border-slate-700/50 hover:border-slate-600 transition-colors">
                            <span
                                class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 text-xs font-bold shrink-0">
                                {{ loop.index }}
                            </span>
                            <p class="text-slate-300 text-sm leading-relaxed">{{ rec }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Auto-Optimize Loop v1 -->
                <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6">
                    <div class="flex items-start md:items-center justify-between gap-4 mb-5">
                        <div>
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Auto-Optimize Loop v1
                            </h3>
                            <p class="text-sm text-slate-400 mt-1">
                                Generate actionable optimization tasks from this report, approve them, and auto re-scan.
                            </p>
                        </div>
                        <button
                            class="px-4 py-2 rounded-lg bg-cyan-500/20 text-cyan-300 border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors text-sm font-semibold"
                            onclick="generateOptimizationActions({{ site.id }}, {{ org_id }})">
                            Generate Actions
                        </button>
                    </div>

                    {% if optimization_actions %}
                    <div class="space-y-3">
                        {% for action in optimization_actions %}
                        <div class="p-4 rounded-xl bg-slate-900/50 border border-slate-700/60">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-0.5 text-xs rounded-full border
                                            {% if action.status == 'pending' %}border-amber-500/40 text-amber-300 bg-amber-500/10{% elif action.status == 'applied' %}border-emerald-500/40 text-emerald-300 bg-emerald-500/10{% elif action.status == 'rejected' %}border-rose-500/40 text-rose-300 bg-rose-500/10{% else %}border-slate-600 text-slate-300 bg-slate-700/40{% endif %}">
                                            {{ action.status }}
                                        </span>
                                        <span class="text-xs text-slate-500">{{ action.loop_version }}</span>
                                    </div>
                                    <h4 class="text-sm font-semibold text-slate-100">{{ action.title }}</h4>
                                    <p class="text-xs text-slate-400 mt-2 leading-relaxed">{{ action.proposed_instruction }}</p>
                                </div>
                                {% if action.status == 'pending' %}
                                <div class="flex gap-2 shrink-0">
                                    <button
                                        class="px-3 py-1.5 rounded-md text-xs font-semibold bg-emerald-500/20 text-emerald-300 border border-emerald-500/30 hover:bg-emerald-500/30 transition-colors"
                                        onclick="approveOptimizationAction({{ action.id }}, {{ org_id }})">
                                        Approve & Apply
                                    </button>
                                    <button
                                        class="px-3 py-1.5 rounded-md text-xs font-semibold bg-rose-500/15 text-rose-300 border border-rose-500/25 hover:bg-rose-500/25 transition-colors"
                                        onclick="rejectOptimizationAction({{ action.id }}, {{ org_id }})">
                                        Reject
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-sm text-slate-400 border border-dashed border-slate-700 rounded-xl p-4">
                        No optimization actions yet. Generate actions to start the approval loop.
                    </div>
                    {% endif %}
                </div>

                <!-- Auto-Optimize Loop v2 -->
                <div class="bg-slate-800/50 backdrop-blur-xl border border-cyan-500/20 rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-5">
                        <div>
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-cyan-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 3v2m6-2v2M9 19v2m6-2v2M4 9h2m14 0h2M4 15h2m14 0h2M8 8h8v8H8z"></path>
                                </svg>
                                Auto-Optimize Loop v2
                            </h3>
                            <p class="text-sm text-slate-400 mt-1">
                                Use bandit scoring to prioritize the next optimization action and learn from reward feedback.
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="bandit-strategy"
                                class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200">
                                <option value="thompson">Thompson</option>
                                <option value="ucb">UCB</option>
                            </select>
                            <button
                                class="px-4 py-2 rounded-lg bg-cyan-500/20 text-cyan-200 border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors text-sm font-semibold"
                                onclick="decideOptimizationActionV2({{ site.id }}, {{ org_id }})">
                                Decide Next (v2)
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="p-4 rounded-xl bg-slate-900/50 border border-slate-700/60">
                            <h4 class="text-sm font-semibold text-slate-200 mb-3">Pending Candidates</h4>
                            {% set pending_actions = optimization_actions | selectattr('status', 'equalto', 'pending') | list %}
                            {% if pending_actions %}
                            <div class="space-y-2">
                                {% for action in pending_actions %}
                                <div class="flex items-start justify-between gap-3 p-3 rounded-lg border border-slate-700/70 bg-slate-950/50">
                                    <div class="min-w-0">
                                        <div class="text-xs text-cyan-300 mb-1">Action #{{ action.id }}</div>
                                        <div class="text-sm text-slate-200 font-medium truncate">{{ action.title }}</div>
                                    </div>
                                    <button
                                        class="px-2.5 py-1 rounded-md text-xs font-semibold bg-emerald-500/20 text-emerald-300 border border-emerald-500/30 hover:bg-emerald-500/30 transition-colors shrink-0"
                                        onclick="approveOptimizationAction({{ action.id }}, {{ org_id }})">
                                        Approve
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-sm text-slate-400">No pending candidates. Generate actions first.</div>
                            {% endif %}
                        </div>

                        <div class="p-4 rounded-xl bg-slate-900/50 border border-slate-700/60">
                            <h4 class="text-sm font-semibold text-slate-200 mb-3">Bandit Arms</h4>
                            {% if bandit_arms %}
                            <div class="space-y-2 max-h-72 overflow-auto pr-1">
                                {% for arm in bandit_arms %}
                                <div class="p-3 rounded-lg border border-slate-700/70 bg-slate-950/50">
                                    <div class="flex items-start justify-between gap-3 mb-2">
                                        <div class="min-w-0">
                                            <div class="text-sm text-slate-100 font-medium truncate">{{ arm.title }}</div>
                                            <div class="text-xs text-slate-400 mt-1">
                                                pulls {{ arm.pulls }} · avg {{ '%.3f'|format(arm.average_reward) }} · status {{ arm.status }}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1 shrink-0">
                                            <button
                                                class="px-2 py-1 rounded text-[11px] border border-emerald-500/30 bg-emerald-500/20 text-emerald-200 hover:bg-emerald-500/30"
                                                onclick="recordOptimizationFeedback({{ arm.action_id }}, {{ org_id }}, 1.0)">
                                                +1.0
                                            </button>
                                            <button
                                                class="px-2 py-1 rounded text-[11px] border border-slate-500/30 bg-slate-700/40 text-slate-200 hover:bg-slate-700/60"
                                                onclick="recordOptimizationFeedback({{ arm.action_id }}, {{ org_id }}, 0.0)">
                                                +0.0
                                            </button>
                                        </div>
                                    </div>
                                    {% if arm.last_reward is not none %}
                                    <div class="text-[11px] text-slate-500">
                                        last reward {{ '%.3f'|format(arm.last_reward) }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-sm text-slate-400">
                                No bandit arms yet. Run "Decide Next (v2)" after generating pending actions.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Technical Evidence (GhostLink Impact) -->
                {% if analysis.ghostlink_impact %}
                <div
                    class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none">
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Technical Evidence: GhostLink Impact
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for impact in analysis.ghostlink_impact %}
                        <div
                            class="bg-slate-900/50 border border-slate-700/50 rounded-xl p-5 hover:border-emerald-500/30 transition-colors group">
                            <div class="flex justify-between items-start mb-3">
                                <h4
                                    class="text-base font-semibold text-emerald-400 group-hover:text-emerald-300 transition-colors">
                                    {{ impact.title }}</h4>
                                <div class="flex items-center gap-2">
                                    <span
                                        class="px-2 py-0.5 rounded-full text-[10px] font-semibold border {% if impact.evidence_type == 'measured' %}bg-cyan-500/15 text-cyan-300 border-cyan-500/35{% else %}bg-amber-500/15 text-amber-300 border-amber-500/35{% endif %}">
                                        {{ impact.source_label }}
                                    </span>
                                    <span
                                        class="px-2.5 py-1 rounded-full bg-emerald-500/10 text-emerald-400 text-xs font-bold border border-emerald-500/20">
                                        {{ impact.improvement }}
                                    </span>
                                </div>
                            </div>
                            <p class="text-slate-300 text-sm leading-relaxed">{{ impact.description }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- SEO & Meta -->
                <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Generated Assets</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-xl bg-slate-900/50 border border-slate-700/50">
                            <h4 class="text-sm font-medium text-slate-400 mb-2">SEO Description</h4>
                            <p class="text-sm text-slate-300 line-clamp-3">{{ site.seo_description }}</p>
                        </div>
                        <div class="p-4 rounded-xl bg-slate-900/50 border border-slate-700/50">
                            <h4 class="text-sm font-medium text-slate-400 mb-2">Schema Type</h4>
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">
                                {{ site.schema_type }}
                            </span>
                        </div>
                    </div>
                </div>

                <div id="integration-guide" class="bg-slate-800/50 backdrop-blur-xl border border-cyan-500/20 rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-5">
                        <div>
                            <h3 class="text-lg font-semibold text-white">Website Integration Guide</h3>
                            <p class="text-sm text-slate-400 mt-1">
                                GhostLink를 고객 사이트에 물리적으로 적용하는 권장 방식입니다.
                            </p>
                        </div>
                        <div class="text-xs {% if installation_status.detected %}text-emerald-300{% else %}text-amber-300{% endif %}">
                            {% if installation_status.detected %}
                            Installation detected (last 7d)
                            {% else %}
                            Installation not detected (last 7d)
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-5">
                        <div class="rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-4">
                            <div class="text-xs uppercase tracking-wider text-emerald-300 mb-2">Recommended</div>
                            <div class="text-sm font-semibold text-slate-100">Global Layout or Tag Manager</div>
                            <p class="text-xs text-slate-300 mt-2">
                                가장 안정적입니다. 사이트의 공통 템플릿 head 또는 GTM Custom HTML로 한 번만 배포하세요.
                            </p>
                        </div>
                        <div class="rounded-xl border border-slate-700/70 bg-slate-900/50 p-4">
                            <div class="text-xs uppercase tracking-wider text-slate-400 mb-2">Static Site</div>
                            <div class="text-sm font-semibold text-slate-100">index.html head에 삽입</div>
                            <p class="text-xs text-slate-300 mt-2">
                                단일 정적 사이트면 `index.html`의 `&lt;/head&gt;` 직전에 넣는 방식이 유효합니다.
                            </p>
                        </div>
                        <div class="rounded-xl border border-slate-700/70 bg-slate-900/50 p-4">
                            <div class="text-xs uppercase tracking-wider text-slate-400 mb-2">Advanced</div>
                            <div class="text-sm font-semibold text-slate-100">Edge Deployments API</div>
                            <p class="text-xs text-slate-300 mt-2">
                                운영 자동화가 필요하면 Edge artifact/deployment API로 환경별(staging/production) 배포를 관리하세요.
                            </p>
                        </div>
                    </div>

                    <div class="rounded-xl border border-slate-700/70 bg-slate-900/50 p-4 mb-4">
                        <div class="text-xs uppercase tracking-wider text-slate-400 mb-2">Paste This Script Once</div>
                        <pre class="text-xs text-cyan-200 overflow-x-auto"><code>&lt;script async src="{{ bridge_script_url }}"&gt;&lt;/script&gt;</code></pre>
                        <div class="flex flex-wrap items-center gap-2 mt-3">
                            <button
                                class="px-3 py-1.5 rounded-md text-xs font-semibold bg-cyan-500/20 text-cyan-200 border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors"
                                onclick="copyScript('{{ bridge_script_url }}')">
                                Copy Script Tag
                            </button>
                            <a href="/docs/integration-guide?org_id={{ org_id }}&site_id={{ site.id }}"
                                class="px-3 py-1.5 rounded-md text-xs font-semibold bg-slate-800 text-slate-200 border border-slate-600 hover:bg-slate-700 transition-colors">
                                Open Full Guide
                            </a>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-400">
                        <div class="rounded-lg border border-slate-700/70 bg-slate-900/40 p-3">
                            Script requests (7d): <span class="text-slate-200 font-semibold">{{ installation_status.script_request_count_7d }}</span>
                        </div>
                        <div class="rounded-lg border border-slate-700/70 bg-slate-900/40 p-3">
                            Bridge events (7d): <span class="text-slate-200 font-semibold">{{ installation_status.bridge_event_count_7d }}</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function getReportSelectedLanguage() {
        const select = document.getElementById('report-language');
        return select ? select.value : 'auto';
    }

    async function updateReportLanguage(siteId, orgId) {
        const language = getReportSelectedLanguage();
        const response = await fetch('/api/sites/language', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `org_id=${encodeURIComponent(orgId)}&language=${encodeURIComponent(language)}&rescan=true`
        });

        let payload = {};
        try {
            payload = await response.json();
        } catch (_) {
            payload = {};
        }

        if (!response.ok) {
            const detail = typeof payload.detail === 'string' ? payload.detail : 'Failed to update language.';
            emitToast(detail);
            return;
        }
        const started = Number(payload.rescan_started || 0);
        const skipped = Number(payload.rescan_skipped_quota || 0);
        emitToast(`Applied to all sites. Rescan started: ${started}, skipped: ${skipped}`);
        setTimeout(() => window.location.reload(), 150);
    }

    async function rescanSiteWithLanguage(siteId, orgId) {
        const language = getReportSelectedLanguage();
        const response = await fetch(`/api/sites/${siteId}/generate?org_id=${encodeURIComponent(orgId)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `language=${encodeURIComponent(language)}`
        });

        if (!response.ok) {
            emitToast('Failed to start rescan.');
            return;
        }
        emitToast('Rescan started');
        setTimeout(() => window.location.reload(), 300);
    }

    async function generateOptimizationActions(siteId, orgId) {
        const response = await fetch(`/api/v1/optimizations/sites/${siteId}/actions/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `org_id=${encodeURIComponent(orgId)}`
        });
        if (!response.ok) {
            alert('Failed to generate optimization actions.');
            return;
        }
        window.location.reload();
    }

    async function approveOptimizationAction(actionId, orgId) {
        const response = await fetch(`/api/v1/optimizations/actions/${actionId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `org_id=${encodeURIComponent(orgId)}`
        });
        if (!response.ok) {
            alert('Failed to approve optimization action.');
            return;
        }
        window.location.reload();
    }

    async function rejectOptimizationAction(actionId, orgId) {
        const response = await fetch(`/api/v1/optimizations/actions/${actionId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `org_id=${encodeURIComponent(orgId)}`
        });
        if (!response.ok) {
            alert('Failed to reject optimization action.');
            return;
        }
        window.location.reload();
    }

    async function decideOptimizationActionV2(siteId, orgId) {
        const strategyEl = document.getElementById('bandit-strategy');
        const strategy = strategyEl ? strategyEl.value : 'thompson';
        const response = await fetch(
            `/api/v1/optimizations/sites/${siteId}/actions/decide-v2?org_id=${encodeURIComponent(orgId)}&strategy=${encodeURIComponent(strategy)}&ensure_candidates=true`,
            { method: 'POST' }
        );

        let payload = {};
        try {
            payload = await response.json();
        } catch (_) {
            payload = {};
        }

        if (!response.ok) {
            const detail = typeof payload.detail === 'string' ? payload.detail : 'Failed to run v2 decision.';
            emitToast(detail);
            return;
        }

        if (payload.selected_action && payload.selected_action.id) {
            const createdCount = Number(payload.created_count || 0);
            const selectedLabel = payload.selected_action.title || `Action #${payload.selected_action.id}`;
            if (createdCount > 0) {
                emitToast(`v2 selected: ${selectedLabel} (generated ${createdCount} new candidates)`);
            } else {
                emitToast(`v2 selected: ${selectedLabel}`);
            }
        } else {
            emitToast('No pending actions available for v2, even after auto-generation.');
        }
        setTimeout(() => window.location.reload(), 250);
    }

    async function recordOptimizationFeedback(actionId, orgId, reward) {
        const response = await fetch(`/api/v1/optimizations/actions/${actionId}/feedback?org_id=${encodeURIComponent(orgId)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reward, notes: 'report_ui_feedback' })
        });

        let payload = {};
        try {
            payload = await response.json();
        } catch (_) {
            payload = {};
        }

        if (!response.ok) {
            const detail = typeof payload.detail === 'string' ? payload.detail : 'Failed to record feedback.';
            emitToast(detail);
            return;
        }
        emitToast('Feedback recorded');
        setTimeout(() => window.location.reload(), 250);
    }

    {% if analysis.scores %}
    const ctx = document.getElementById('scoreRadarChart').getContext('2d');

    // Gradient for the radar chart area
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); // Emerald-500
    gradient.addColorStop(1, 'rgba(6, 182, 212, 0.2)'); // Cyan-500

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Usability', 'SEO', 'Content Quality', 'Performance', 'Accessibility'], // Added extra labels for visual balance if only 3 are provided, key is to map them correctly. 
            // Our AI service returns: usability, seo, content_quality. Let's map them and maybe duplicate or add placeholder if needed for a nice shape.
            // Actually, let's just use the keys we have.
            labels: ['Usability', 'SEO', 'Content Quality'],
            datasets: [{
                label: 'Score',
                data: [{{ analysis.scores.usability }}, {{ analysis.scores.seo }}, {{ analysis.scores.content_quality }}],
        fill: true,
        backgroundColor: 'rgba(16, 185, 129, 0.2)',
        borderColor: '#10b981', // Emerald-500
        pointBackgroundColor: '#10b981',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: '#10b981',
        borderWidth: 2,
        pointRadius: 4
            }]
        },
        options: {
        scales: {
            r: {
                angleLines: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                pointLabels: {
                    color: '#94a3b8', // slate-400
                    font: {
                        size: 12,
                        family: "'Inter', sans-serif"
                    }
                },
                ticks: {
                    display: false, // Hide numeric ticks for cleaner look
                    backdropColor: 'transparent'
                },
                suggestedMin: 0,
                suggestedMax: 100
            }
        },
        plugins: {
            legend: {
                display: false
            }
        },
        maintainAspectRatio: false
    }
    });
    {% endif %}
</script>
{% endblock %}
