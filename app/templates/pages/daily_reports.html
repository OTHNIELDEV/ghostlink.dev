{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-[calc(100vh-64px)] overflow-hidden">
    {% include 'components/sidebar.html' %}

    <div class="flex-1 overflow-auto p-8 bg-slate-950">
        {% set evidence = summary.evidence if summary.evidence is defined else {} %}
        {% set proof_evidence = evidence.proof if evidence.proof is defined else {} %}
        {% set attribution_evidence = evidence.attribution if evidence.attribution is defined else {} %}
        {% set optimization_impact = summary.optimization_impact if summary.optimization_impact is defined else {"items": [], "totals": {"measured_count": 0, "pending_count": 0, "positive_count": 0}} %}
        {% set impact_totals = optimization_impact.get("totals", {}) if optimization_impact.get is defined else {} %}
        {% set impact_items = optimization_impact.get("items", []) if optimization_impact.get is defined else [] %}
        <div class="max-w-6xl mx-auto space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">일일 리포트</h1>
                    <p class="text-slate-400 mt-2">
                        최종 서비스 이용자 공유용 일자별 PDF 리포트를 다운로드합니다.
                    </p>
                </div>
                <form method="get" action="/reports/daily" class="flex items-end gap-2">
                    <input type="hidden" name="org_id" value="{{ org_id }}">
                    <div>
                        <label class="text-xs uppercase tracking-wider text-slate-500">리포트 날짜</label>
                        <input type="date" name="date" value="{{ summary.report_date }}"
                            class="mt-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200">
                    </div>
                    <button type="submit"
                        class="px-4 py-2 rounded-lg border border-slate-600 bg-slate-800 text-slate-200 hover:bg-slate-700 text-sm font-semibold">
                        적용
                    </button>
                    <a href="/api/v1/reports/daily.pdf?org_id={{ org_id }}&date={{ summary.report_date }}"
                        class="px-4 py-2 rounded-lg border border-emerald-500/40 bg-emerald-500/15 text-emerald-200 hover:bg-emerald-500/25 text-sm font-semibold">
                        PDF 다운로드
                    </a>
                </form>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
                <div class="glass border border-slate-700/60 rounded-xl p-4">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">사이트 수</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">
                            {{ (evidence.site_count if evidence.site_count is defined else 'measured') }}
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-white mt-1">{{ summary.site_count }}</div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-4">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">평균 가시성</div>
                        <span class="px-2 py-0.5 rounded-full border border-amber-500/35 bg-amber-500/10 text-[10px] text-amber-300 uppercase tracking-wider">
                            {{ (evidence.avg_visibility_score if evidence.avg_visibility_score is defined else 'predicted') }}
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-white mt-1">{{ summary.avg_visibility_score }}</div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-4">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">AI 크롤러</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">
                            {{ (evidence.ai_crawler_visits if evidence.ai_crawler_visits is defined else 'measured') }}
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-white mt-1">{{ summary.ai_crawler_visits }}</div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-4">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">프루프 ACR</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">
                            {{ (proof_evidence.answer_capture_rate_pct if proof_evidence.answer_capture_rate_pct is defined else 'measured') }}
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-white mt-1">{{ summary.proof.answer_capture_rate_pct }}%</div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-4">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">AI 기여</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">
                            {{ (attribution_evidence.ai_assist_rate_pct if attribution_evidence.ai_assist_rate_pct is defined else 'measured') }}
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-white mt-1">{{ summary.attribution.ai_assist_rate_pct }}%</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="glass border border-slate-700/60 rounded-2xl p-5">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <h2 class="text-base font-semibold text-white">프루프 지표 (일간)</h2>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">measured</span>
                            <span class="px-2 py-0.5 rounded-full border border-cyan-500/35 bg-cyan-500/10 text-[10px] text-cyan-300 uppercase tracking-wider">신뢰도 {{ summary.proof.confidence_level if summary.proof.confidence_level is defined else 'low' }}</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-slate-300">
                        <div>완료 실행: <span class="text-white font-semibold">{{ summary.proof.run_count }}</span></div>
                        <div>평가 질의 수: <span class="text-white font-semibold">{{ summary.proof.total_queries_scored }}</span></div>
                        <div>인용률: <span class="text-white font-semibold">{{ summary.proof.citation_rate_pct }}%</span></div>
                        <div>평균 품질 점수: <span class="text-white font-semibold">{{ summary.proof.average_quality_score }}</span></div>
                        <div>표본 수: <span class="text-white font-semibold">{{ summary.proof.sample_size if summary.proof.sample_size is defined else summary.proof.total_queries_scored }}</span></div>
                    </div>
                </div>
                <div class="glass border border-slate-700/60 rounded-2xl p-5">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <h2 class="text-base font-semibold text-white">어트리뷰션 (일간)</h2>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">measured</span>
                            <span class="px-2 py-0.5 rounded-full border border-cyan-500/35 bg-cyan-500/10 text-[10px] text-cyan-300 uppercase tracking-wider">신뢰도 {{ summary.attribution.confidence_level if summary.attribution.confidence_level is defined else 'low' }}</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-slate-300">
                        <div>전체 이벤트: <span class="text-white font-semibold">{{ summary.attribution.total_events }}</span></div>
                        <div>전환 수: <span class="text-white font-semibold">{{ summary.attribution.conversions_total }}</span></div>
                        <div>AI 보조 전환 수: <span class="text-white font-semibold">{{ summary.attribution.ai_assisted_conversions }}</span></div>
                        <div>AI 기여 전환율: <span class="text-white font-semibold">{{ summary.attribution.ai_assist_rate_pct }}%</span></div>
                    </div>
                </div>
            </div>

            <div class="glass border border-slate-700/60 rounded-2xl p-5">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-3">
                    <div>
                        <h2 class="text-base font-semibold text-white">고객 신뢰 내러티브</h2>
                        <p class="text-sm text-slate-400">
                            적용한 최적화 액션이 고객 체감 KPI에 어떤 변화를 만들었는지 요약합니다.
                        </p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-[10px] uppercase tracking-wider">
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-emerald-300">
                            실측 {{ impact_totals.get("measured_count", 0) if impact_totals.get is defined else 0 }}
                        </span>
                        <span class="px-2 py-0.5 rounded-full border border-amber-500/35 bg-amber-500/10 text-amber-300">
                            대기 {{ impact_totals.get("pending_count", 0) if impact_totals.get is defined else 0 }}
                        </span>
                    </div>
                </div>
                {% if impact_items %}
                <div class="space-y-3">
                    {% for row in impact_items %}
                    <div class="rounded-xl border border-slate-700/70 bg-slate-900/50 p-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                            <div class="text-sm font-semibold text-slate-100">{{ row.title }}</div>
                            <span class="px-2 py-0.5 rounded-full border {% if row.evidence_type == 'measured' %}border-emerald-500/35 bg-emerald-500/10 text-emerald-300{% else %}border-amber-500/35 bg-amber-500/10 text-amber-300{% endif %} text-[10px] uppercase tracking-wider">
                                {{ row.evidence_type }}
                            </span>
                        </div>
                        <div class="text-xs text-slate-500 mt-1">{{ row.site_label }}</div>
                        <p class="text-sm text-slate-300 mt-2">{{ row.narrative }}</p>
                        {% if row.evidence_type == 'measured' %}
                        <div class="mt-2 text-xs text-cyan-300">
                            Δ Proof {{ '+' if row.delta_proof_score >= 0 else '' }}{{ row.delta_proof_score }} · 보상 {{ row.reward }} · 신뢰도 {{ row.confidence_level }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="rounded-xl border border-dashed border-slate-700 p-4 text-sm text-slate-400">
                    오늘은 자동 측정된 최적화 내러티브가 없습니다.
                </div>
                {% endif %}
            </div>

            <div class="glass border border-slate-700/60 rounded-2xl p-5">
                <h2 class="text-base font-semibold text-white mb-3">사이트 상태 스냅샷</h2>
                <div class="overflow-auto">
                    <table class="w-full text-left">
                        <thead class="text-xs uppercase tracking-wider text-slate-500">
                            <tr>
                                <th class="py-2">사이트</th>
                                <th class="py-2">상태</th>
                                <th class="py-2">점수</th>
                                <th class="py-2">스키마</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            {% for site in summary.sites %}
                            <tr>
                                <td class="py-2 text-sm text-slate-200">{{ site.url }}</td>
                                <td class="py-2 text-sm text-slate-400">{{ site.status }}</td>
                                <td class="py-2 text-sm text-slate-200">{{ site.ai_score }}</td>
                                <td class="py-2 text-sm text-slate-400">{{ site.schema_type }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
