{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-[calc(100vh-64px)] overflow-hidden">
    {% include 'components/sidebar.html' %}

    <div class="flex-1 overflow-auto p-8 bg-slate-950">
        <div class="max-w-7xl mx-auto space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Proof Center</h1>
                    <p class="text-slate-400 mt-2">
                        AI 검색 효율을 실측 지표로 증명하고, 전후 개선 결과를 확인합니다.
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/billing?org_id={{ org_id }}"
                        class="px-4 py-2 rounded-lg border border-emerald-500/40 bg-emerald-500/15 text-emerald-200 hover:bg-emerald-500/25 text-sm font-semibold transition-colors">
                        Compare Plans
                    </a>
                    <a href="/dashboard?org_id={{ org_id }}"
                        class="px-4 py-2 rounded-lg border border-slate-600 bg-slate-800 text-slate-200 hover:bg-slate-700 text-sm font-semibold transition-colors">
                        Dashboard
                    </a>
                </div>
            </div>

            {% if onboarding %}
            <div class="glass border border-slate-700/60 rounded-2xl p-5">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-white">Activation Progress</h2>
                        <p class="text-sm text-slate-400">
                            {{ onboarding.completed_count }}/{{ onboarding.total_steps }} steps complete
                        </p>
                    </div>
                    {% if onboarding.next_step %}
                    <a href="{{ onboarding.next_step.action_url }}"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-cyan-500/40 bg-cyan-500/15 text-cyan-200 hover:bg-cyan-500/25 text-sm font-semibold transition-colors">
                        Next: {{ onboarding.next_step.title }}
                    </a>
                    {% endif %}
                </div>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden mb-4">
                    <div class="h-full bg-emerald-500" style="width: {{ onboarding.progress_pct }}%"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3">
                    {% for step in onboarding.steps %}
                    <div class="rounded-lg border p-3 {% if step.status == 'completed' %}border-emerald-500/30 bg-emerald-500/10{% else %}border-slate-700/70 bg-slate-900/50{% endif %}">
                        <div class="text-xs uppercase tracking-wider {% if step.status == 'completed' %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            {{ step.status }}
                        </div>
                        <div class="text-sm font-semibold text-slate-100 mt-1">{{ step.title }}</div>
                        <div class="text-xs text-slate-400 mt-1">{{ step.description }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="flex flex-wrap items-center gap-2 text-xs">
                <span class="px-2 py-1 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-emerald-300 uppercase tracking-wider">Measured KPIs</span>
                <span class="px-2 py-1 rounded-full border border-cyan-500/35 bg-cyan-500/10 text-cyan-300 uppercase tracking-wider">Confidence {{ overview.confidence_level }}</span>
                <span class="px-2 py-1 rounded-full border border-slate-600 bg-slate-900 text-slate-300 uppercase tracking-wider">Sample {{ overview.sample_size }}</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
                <div class="glass border border-slate-700/60 rounded-xl p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Proof Score</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">measured</span>
                    </div>
                    <div class="text-3xl font-bold text-white mt-1">{{ overview.proof_score }}</div>
                    <div class="text-xs mt-2 {% if overview.deltas.proof_score >= 0 %}text-emerald-400{% else %}text-rose-400{% endif %}">
                        {% if overview.deltas.proof_score >= 0 %}+{% endif %}{{ overview.deltas.proof_score }} vs prev
                    </div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Answer Capture Rate</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">measured</span>
                    </div>
                    <div class="text-3xl font-bold text-white mt-1">{{ overview.answer_capture_rate_pct }}%</div>
                    <div class="text-xs mt-2 {% if overview.deltas.answer_capture_rate_pct >= 0 %}text-emerald-400{% else %}text-rose-400{% endif %}">
                        {% if overview.deltas.answer_capture_rate_pct >= 0 %}+{% endif %}{{ overview.deltas.answer_capture_rate_pct }}pp
                    </div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Citation Rate</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">measured</span>
                    </div>
                    <div class="text-3xl font-bold text-white mt-1">{{ overview.citation_rate_pct }}%</div>
                    <div class="text-xs mt-2 {% if overview.deltas.citation_rate_pct >= 0 %}text-emerald-400{% else %}text-rose-400{% endif %}">
                        {% if overview.deltas.citation_rate_pct >= 0 %}+{% endif %}{{ overview.deltas.citation_rate_pct }}pp
                    </div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">AI Assist Rate</div>
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-[10px] text-emerald-300 uppercase tracking-wider">measured</span>
                    </div>
                    <div class="text-3xl font-bold text-white mt-1">{{ overview.ai_assist_rate_pct }}%</div>
                    <div class="text-xs mt-2 {% if overview.deltas.ai_assist_rate_pct >= 0 %}text-emerald-400{% else %}text-rose-400{% endif %}">
                        {% if overview.deltas.ai_assist_rate_pct >= 0 %}+{% endif %}{{ overview.deltas.ai_assist_rate_pct }}pp
                    </div>
                </div>
                <div class="glass border border-slate-700/60 rounded-xl p-5">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Sample & Confidence</div>
                        <span class="px-2 py-0.5 rounded-full border border-cyan-500/35 bg-cyan-500/10 text-[10px] text-cyan-300 uppercase tracking-wider">measured</span>
                    </div>
                    <div class="text-3xl font-bold text-white mt-1">{{ overview.sample_size }}</div>
                    <div class="text-xs mt-2 text-cyan-300 uppercase tracking-wider">{{ overview.confidence_level }}</div>
                </div>
            </div>

            {% set impact = optimization_impact if optimization_impact is defined else {"items": [], "totals": {"measured_count": 0, "pending_count": 0, "positive_count": 0}} %}
            {% set impact_totals = impact.get("totals", {}) if impact.get is defined else {} %}
            {% set impact_items = impact.get("items", []) if impact.get is defined else [] %}
            <div class="glass border border-slate-700/60 rounded-2xl p-6">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-white">Optimization Impact Narrative</h2>
                        <p class="text-sm text-slate-400">
                            어떤 액션이 실제 Proof Score 변화에 기여했는지 고객 관점으로 설명합니다.
                        </p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-[10px] uppercase tracking-wider">
                        <span class="px-2 py-0.5 rounded-full border border-emerald-500/35 bg-emerald-500/10 text-emerald-300">
                            measured {{ impact_totals.get("measured_count", 0) if impact_totals.get is defined else 0 }}
                        </span>
                        <span class="px-2 py-0.5 rounded-full border border-amber-500/35 bg-amber-500/10 text-amber-300">
                            pending {{ impact_totals.get("pending_count", 0) if impact_totals.get is defined else 0 }}
                        </span>
                        <span class="px-2 py-0.5 rounded-full border border-cyan-500/35 bg-cyan-500/10 text-cyan-300">
                            positive lift {{ impact_totals.get("positive_count", 0) if impact_totals.get is defined else 0 }}
                        </span>
                    </div>
                </div>

                {% if impact_items %}
                <div class="space-y-3">
                    {% for row in impact_items %}
                    <div class="rounded-xl border border-slate-700/70 bg-slate-900/50 p-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                            <div class="text-sm font-semibold text-slate-100">{{ row.title }}</div>
                            <span class="px-2 py-0.5 rounded-full border {% if row.evidence_type == 'measured' %}border-emerald-500/35 bg-emerald-500/10 text-emerald-300{% else %}border-amber-500/35 bg-amber-500/10 text-amber-300{% endif %} text-[10px] uppercase tracking-wider">
                                {{ row.evidence_type }}
                            </span>
                        </div>
                        <div class="text-xs text-slate-500 mt-1">{{ row.site_label }}</div>
                        <p class="text-sm text-slate-300 mt-2">{{ row.narrative }}</p>
                        {% if row.evidence_type == 'measured' %}
                        <div class="mt-3 flex flex-wrap items-center gap-2 text-[11px]">
                            <span class="px-2 py-0.5 rounded-md border border-slate-600 bg-slate-950 text-slate-300">
                                Δ Proof {{ '+' if row.delta_proof_score >= 0 else '' }}{{ row.delta_proof_score }}
                            </span>
                            <span class="px-2 py-0.5 rounded-md border border-cyan-500/35 bg-cyan-500/10 text-cyan-300">
                                Reward {{ row.reward }}
                            </span>
                            <span class="px-2 py-0.5 rounded-md border border-slate-600 bg-slate-950 text-slate-300 uppercase">
                                Confidence {{ row.confidence_level }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="rounded-xl border border-dashed border-slate-700 p-4 text-sm text-slate-400">
                    적용된 최적화 액션이 아직 없거나, post-action snapshot이 없어 측정 내러티브를 생성하지 못했습니다.
                </div>
                {% endif %}
            </div>

            <div id="query-set" class="glass border border-slate-700/60 rounded-2xl p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-5">
                    <div>
                        <h2 class="text-lg font-semibold text-white">Before / After Evidence</h2>
                        <p class="text-sm text-slate-400">
                            Query별 baseline 대비 최신 run 결과를 비교합니다.
                        </p>
                    </div>
                    <form method="get" action="/proof" class="flex items-center gap-2">
                        <input type="hidden" name="org_id" value="{{ org_id }}">
                        <label class="text-xs text-slate-400 uppercase tracking-wider">Query Set</label>
                        <select name="query_set_id"
                            class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200">
                            {% for row in query_sets %}
                            <option value="{{ row.id }}" {% if row.id == selected_query_set_id %}selected{% endif %}>{{ row.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit"
                            class="px-3 py-2 rounded-lg border border-slate-600 bg-slate-800 text-slate-200 hover:bg-slate-700 text-sm font-semibold transition-colors">
                            Apply
                        </button>
                    </form>
                </div>

                {% if before_after.available %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
                    <div class="rounded-lg border border-slate-700/60 bg-slate-900/50 p-3">
                        <div class="text-xs text-slate-500 uppercase tracking-wider">Items Compared</div>
                        <div class="text-xl font-bold text-white mt-1">{{ before_after.summary.query_item_count }}</div>
                    </div>
                    <div class="rounded-lg border border-slate-700/60 bg-slate-900/50 p-3">
                        <div class="text-xs text-slate-500 uppercase tracking-wider">Brand Wins</div>
                        <div class="text-xl font-bold text-emerald-300 mt-1">{{ before_after.summary.brand_improved_count }}</div>
                    </div>
                    <div class="rounded-lg border border-slate-700/60 bg-slate-900/50 p-3">
                        <div class="text-xs text-slate-500 uppercase tracking-wider">Citation Wins</div>
                        <div class="text-xl font-bold text-cyan-300 mt-1">{{ before_after.summary.citation_improved_count }}</div>
                    </div>
                </div>

                <div class="space-y-3 max-h-[520px] overflow-auto pr-1">
                    {% for row in before_after["items"] %}
                    <div class="rounded-xl border border-slate-700/70 bg-slate-900/40 p-4">
                        <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Query</div>
                        <div class="text-sm font-semibold text-slate-100 mb-3">{{ row.prompt_text }}</div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                            <div class="rounded-lg border border-slate-700/60 bg-slate-950/60 p-3">
                                <div class="text-xs text-slate-500 uppercase tracking-wider mb-2">Baseline</div>
                                <div class="text-xs text-slate-300 mb-2">{{ (row.baseline.answer_text or '-')[0:220] }}</div>
                                <div class="text-[11px] text-slate-400">
                                    Brand: {{ 'Yes' if row.baseline.has_brand_mention else 'No' }} ·
                                    Citation: {{ 'Yes' if row.baseline.has_site_citation else 'No' }} ·
                                    Quality: {{ row.baseline.quality_score }}
                                </div>
                            </div>
                            <div class="rounded-lg border border-emerald-500/30 bg-emerald-500/5 p-3">
                                <div class="text-xs text-emerald-300 uppercase tracking-wider mb-2">Latest</div>
                                <div class="text-xs text-slate-200 mb-2">{{ (row.latest.answer_text or '-')[0:220] }}</div>
                                <div class="text-[11px] text-slate-300">
                                    Brand: {{ 'Yes' if row.latest.has_brand_mention else 'No' }} ·
                                    Citation: {{ 'Yes' if row.latest.has_site_citation else 'No' }} ·
                                    Quality: {{ row.latest.quality_score }}
                                </div>
                                <div class="text-[11px] mt-2 {% if row.delta.quality_score >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                                    Quality Δ: {% if row.delta.quality_score >= 0 %}+{% endif %}{{ row.delta.quality_score }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="rounded-xl border border-dashed border-slate-700 p-5 text-slate-400 text-sm">
                    {{ before_after.message }}
                    <div id="run-proof" class="mt-3 text-slate-300">
                        다음 단계: Query Set과 Query를 만든 뒤 `/api/v1/answer-capture/runs`를 2회 이상 실행하세요.
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="glass border border-slate-700/60 rounded-2xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Plan Value Ladder</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3">
                    {% for row in plan_value_ladder %}
                    <div class="rounded-xl border p-4 {% if row.is_current %}border-emerald-500/40 bg-emerald-500/10{% else %}border-slate-700/70 bg-slate-900/50{% endif %}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm font-semibold text-white">{{ row.name }}</div>
                            {% if row.is_current %}
                            <span class="text-[10px] uppercase tracking-wider text-emerald-300">Current</span>
                            {% endif %}
                        </div>
                        <div class="text-xs text-cyan-300 uppercase tracking-wider">{{ row.headline }}</div>
                        <div class="text-xs text-slate-300 mt-2">{{ row.value }}</div>
                        <div class="text-[11px] text-slate-500 mt-3">
                            Sites: {{ '∞' if row.sites_limit <= 0 else row.sites_limit }} ·
                            Scans/mo: {{ '∞' if row.scan_limit <= 0 else row.scan_limit }} ·
                            Team: {{ '∞' if row.team_limit <= 0 else row.team_limit }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="glass border border-slate-700/60 rounded-2xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Saved Proof Snapshots</h2>
                {% if snapshots %}
                <div class="space-y-2">
                    {% for row in snapshots %}
                    <div class="rounded-lg border border-slate-700/70 bg-slate-900/40 p-3 flex items-center justify-between gap-4">
                        <div>
                            <div class="text-sm text-slate-100 font-semibold">
                                {{ row.period_start.strftime('%Y-%m-%d') if row.period_start else '-' }}
                                ~
                                {{ row.period_end.strftime('%Y-%m-%d') if row.period_end else '-' }}
                            </div>
                            <div class="text-xs text-slate-400">
                                ACR {{ row.answer_capture_rate_pct }}% · Citation {{ row.citation_rate_pct }}% · AI Assist {{ row.ai_assist_rate_pct }}%
                            </div>
                        </div>
                        <div class="text-sm text-cyan-300 uppercase tracking-wider">{{ row.confidence_level }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-sm text-slate-400">No snapshots yet. Use `POST /api/v1/proof/snapshots` to save periodic proof records.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
